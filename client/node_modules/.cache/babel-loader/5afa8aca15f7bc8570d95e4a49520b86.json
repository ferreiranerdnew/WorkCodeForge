{"ast":null,"code":"// src/middleware/socketRTK.js\nimport { wsEndpoint } from '../utils/constants';\nimport { io } from 'socket.io-client';\nimport { createPeer, addPeer } from '../utils/peerManager';\nimport { SET_VIDEO_PARTICIPANTS, SET_SOCKETID, USER_DISCONNECT } from '../reducers/mapReducer'; // Definir as novas ações aqui até serem adicionadas ao mapReducer\n\nconst SET_ONLINE_USERS = 'SET_ONLINE_USERS';\nconst ADD_ONLINE_USER = 'ADD_ONLINE_USER';\nconst REMOVE_ONLINE_USER = 'REMOVE_ONLINE_USER';\nconst RECEIVE_MESSAGE = 'RECEIVE_MESSAGE';\nconst RECEIVE_PRIVATE_MESSAGE = 'RECEIVE_PRIVATE_MESSAGE';\nconst UPDATE_USER_STATUS = 'UPDATE_USER_STATUS';\nconst RECEIVE_TYPING_STATUS = 'RECEIVE_TYPING_STATUS';\nconst RECEIVE_USER_JOINED = 'RECEIVE_USER_JOINED';\nconst RECEIVE_USER_LEFT = 'RECEIVE_USER_LEFT';\nexport const socketRTK = () => {\n  return storeAPI => {\n    const socket = io(wsEndpoint, {\n      transports: ['websocket']\n    });\n    const peers = {}; // socketId => Peer instance\n    // Armazena o socket ID no Redux\n\n    socket.on('connect', () => {\n      storeAPI.dispatch(SET_SOCKETID({\n        id: socket.id\n      })); // Indica ao servidor que deseja participar da sala de vídeo\n\n      socket.emit('joinVideo'); // Solicita lista de usuários online\n\n      socket.emit('requestOnlineUsers'); // Emite status de usuário conectado\n\n      socket.emit('userStatus', {\n        status: 'online',\n        userId: socket.id,\n        timestamp: Date.now()\n      });\n    }); // === EVENTOS DE VÍDEO ===\n    // Recebe lista de participantes de vídeo\n\n    socket.on('userList', users => {\n      if (Array.isArray(users)) {\n        storeAPI.dispatch(SET_VIDEO_PARTICIPANTS(users));\n      }\n    }); // Quando um novo usuário inicia um peer com você\n\n    socket.on('sending-signal', ({\n      userToSignal,\n      callerID,\n      signal\n    }) => {\n      const peer = addPeer({\n        signal,\n        callerID\n      }, storeAPI.getState().video.localStream, socket);\n      peers[callerID] = peer;\n    }); // Quando um usuário retorna sinal\n\n    socket.on('returning-signal', ({\n      callerID,\n      signal\n    }) => {\n      const peer = peers[callerID];\n      if (peer) peer.signal(signal);\n    }); // === EVENTOS DE USUÁRIOS ONLINE ===\n    // Lista completa de usuários online\n\n    socket.on('onlineUsers', users => {\n      storeAPI.dispatch({\n        type: SET_ONLINE_USERS,\n        payload: users\n      });\n    }); // Novo usuário entrou online\n\n    socket.on('userJoined', user => {\n      storeAPI.dispatch({\n        type: ADD_ONLINE_USER,\n        payload: user\n      });\n      storeAPI.dispatch({\n        type: RECEIVE_USER_JOINED,\n        payload: {\n          message: `${user.name || user.id} entrou na plataforma`,\n          userId: user.id,\n          timestamp: Date.now()\n        }\n      });\n    }); // Usuário saiu\n\n    socket.on('userLeft', user => {\n      storeAPI.dispatch({\n        type: REMOVE_ONLINE_USER,\n        payload: user.id\n      });\n      storeAPI.dispatch({\n        type: RECEIVE_USER_LEFT,\n        payload: {\n          message: `${user.name || user.id} saiu da plataforma`,\n          userId: user.id,\n          timestamp: Date.now()\n        }\n      });\n    }); // Status de usuário atualizado\n\n    socket.on('userStatusUpdate', ({\n      userId,\n      status,\n      lastSeen\n    }) => {\n      storeAPI.dispatch({\n        type: UPDATE_USER_STATUS,\n        payload: {\n          userId,\n          status,\n          lastSeen\n        }\n      });\n    }); // === EVENTOS DE MENSAGENS ===\n    // Mensagem pública no chat geral\n\n    socket.on('publicMessage', messageData => {\n      storeAPI.dispatch({\n        type: RECEIVE_MESSAGE,\n        payload: {\n          id: messageData.id || Date.now(),\n          senderId: messageData.senderId,\n          senderName: messageData.senderName,\n          content: messageData.content,\n          timestamp: messageData.timestamp,\n          type: 'public'\n        }\n      });\n    }); // Mensagem privada\n\n    socket.on('privateMessage', messageData => {\n      storeAPI.dispatch({\n        type: RECEIVE_PRIVATE_MESSAGE,\n        payload: {\n          id: messageData.id || Date.now(),\n          senderId: messageData.senderId,\n          senderName: messageData.senderName,\n          recipientId: messageData.recipientId,\n          content: messageData.content,\n          timestamp: messageData.timestamp,\n          type: 'private'\n        }\n      });\n    }); // Status de digitação\n\n    socket.on('userTyping', ({\n      userId,\n      userName,\n      isTyping\n    }) => {\n      storeAPI.dispatch({\n        type: RECEIVE_TYPING_STATUS,\n        payload: {\n          userId,\n          userName,\n          isTyping,\n          timestamp: Date.now()\n        }\n      });\n    }); // === EVENTOS DE DESCONEXÃO ===\n\n    socket.on('userDisconnect', socketId => {\n      storeAPI.dispatch({\n        type: USER_DISCONNECT,\n        payload: socketId\n      });\n      storeAPI.dispatch({\n        type: REMOVE_ONLINE_USER,\n        payload: socketId\n      });\n\n      if (peers[socketId]) {\n        peers[socketId].destroy();\n        delete peers[socketId];\n      }\n    }); // === EVENTOS EXISTENTES ===\n\n    socket.on('movementMessage', arg => {\n      try {\n        const action = JSON.parse(arg);\n        storeAPI.dispatch(action);\n      } catch (err) {\n        console.error('Erro movementMessage:', err);\n      }\n    });\n    socket.on('receivedAnnouncement', arg => {\n      try {\n        const action = JSON.parse(arg);\n        storeAPI.dispatch(action);\n      } catch (err) {\n        console.error('Erro announcement:', err);\n      }\n    });\n    socket.on('receiveDirect', arg => {\n      if ((arg === null || arg === void 0 ? void 0 : arg.type) && (arg === null || arg === void 0 ? void 0 : arg.payload)) {\n        storeAPI.dispatch(arg);\n      }\n    }); // === EVENTOS DE ERRO ===\n\n    socket.on('error', error => {\n      console.error('Socket error:', error);\n    });\n    socket.on('disconnect', () => {\n      console.log('Desconectado do servidor');\n    }); // === MIDDLEWARE REDUX ===\n\n    return next => action => {\n      const result = next(action);\n      const state = storeAPI.getState();\n\n      switch (action.type) {\n        case 'JOIN_VIDEO':\n          // Criar peers iniciadores para cada participante\n          const {\n            video\n          } = state;\n          video.socketArr.forEach(userId => {\n            if (userId !== socket.id && !peers[userId]) {\n              const peer = createPeer(userId, socket.id, video.localStream, socket);\n              peers[userId] = peer;\n            }\n          });\n          break;\n\n        case 'WALK':\n          socket.volatile.emit('movementMessage', JSON.stringify({\n            type: 'UPDATE_OTHERS',\n            payload: state.players[action.payload.id]\n          }));\n          break;\n\n        case 'ANNOUNCEMENT':\n          socket.emit('announcement', JSON.stringify({\n            type: 'RECEIVED_ANNOUNCEMENT',\n            payload: state.outgoingGif\n          }));\n          break;\n\n        case 'SEND_DIRECT':\n          socket.emit('sendDirect', {\n            type: 'RECEIVE_DIRECT',\n            payload: state.outgoingGif\n          });\n          break;\n        // === NOVAS AÇÕES DE COMUNICAÇÃO ===\n\n        case 'SEND_PUBLIC_MESSAGE':\n          socket.emit('publicMessage', {\n            content: action.payload.content,\n            senderId: socket.id,\n            senderName: action.payload.senderName || 'Anônimo',\n            timestamp: Date.now()\n          });\n          break;\n\n        case 'SEND_PRIVATE_MESSAGE':\n          socket.emit('privateMessage', {\n            content: action.payload.content,\n            recipientId: action.payload.recipientId,\n            senderId: socket.id,\n            senderName: action.payload.senderName || 'Anônimo',\n            timestamp: Date.now()\n          });\n          break;\n\n        case 'SET_TYPING_STATUS':\n          socket.emit('typing', {\n            isTyping: action.payload.isTyping,\n            userId: socket.id,\n            userName: action.payload.userName || 'Anônimo'\n          });\n          break;\n\n        case 'UPDATE_USER_PROFILE':\n          socket.emit('updateProfile', {\n            userId: socket.id,\n            profile: action.payload\n          });\n          break;\n\n        case 'REQUEST_USER_INFO':\n          socket.emit('requestUserInfo', {\n            userId: action.payload.userId\n          });\n          break;\n\n        case 'BLOCK_USER':\n          socket.emit('blockUser', {\n            userId: socket.id,\n            blockedUserId: action.payload.userId\n          });\n          break;\n\n        case 'UNBLOCK_USER':\n          socket.emit('unblockUser', {\n            userId: socket.id,\n            unblockedUserId: action.payload.userId\n          });\n          break;\n\n        case 'REPORT_USER':\n          socket.emit('reportUser', {\n            reporterId: socket.id,\n            reportedUserId: action.payload.userId,\n            reason: action.payload.reason\n          });\n          break;\n\n        case 'JOIN_ROOM':\n          socket.emit('joinRoom', {\n            roomId: action.payload.roomId,\n            userId: socket.id\n          });\n          break;\n\n        case 'LEAVE_ROOM':\n          socket.emit('leaveRoom', {\n            roomId: action.payload.roomId,\n            userId: socket.id\n          });\n          break;\n\n        case 'SEND_ROOM_MESSAGE':\n          socket.emit('roomMessage', {\n            roomId: action.payload.roomId,\n            content: action.payload.content,\n            senderId: socket.id,\n            senderName: action.payload.senderName || 'Anônimo',\n            timestamp: Date.now()\n          });\n          break;\n\n        default:\n          break;\n      }\n\n      return result;\n    };\n  };\n}; // === FUNÇÕES AUXILIARES ===\n\nexport const createCommunicationActions = () => ({\n  // Mensagens públicas\n  sendPublicMessage: (content, senderName) => ({\n    type: 'SEND_PUBLIC_MESSAGE',\n    payload: {\n      content,\n      senderName\n    }\n  }),\n  // Mensagens privadas\n  sendPrivateMessage: (content, recipientId, senderName) => ({\n    type: 'SEND_PRIVATE_MESSAGE',\n    payload: {\n      content,\n      recipientId,\n      senderName\n    }\n  }),\n  // Status de digitação\n  setTypingStatus: (isTyping, userName) => ({\n    type: 'SET_TYPING_STATUS',\n    payload: {\n      isTyping,\n      userName\n    }\n  }),\n  // Atualizar perfil\n  updateUserProfile: profile => ({\n    type: 'UPDATE_USER_PROFILE',\n    payload: profile\n  }),\n  // Solicitar informações do usuário\n  requestUserInfo: userId => ({\n    type: 'REQUEST_USER_INFO',\n    payload: {\n      userId\n    }\n  }),\n  // Bloquear usuário\n  blockUser: userId => ({\n    type: 'BLOCK_USER',\n    payload: {\n      userId\n    }\n  }),\n  // Desbloquear usuário\n  unblockUser: userId => ({\n    type: 'UNBLOCK_USER',\n    payload: {\n      userId\n    }\n  }),\n  // Reportar usuário\n  reportUser: (userId, reason) => ({\n    type: 'REPORT_USER',\n    payload: {\n      userId,\n      reason\n    }\n  }),\n  // Gerenciar salas\n  joinRoom: roomId => ({\n    type: 'JOIN_ROOM',\n    payload: {\n      roomId\n    }\n  }),\n  leaveRoom: roomId => ({\n    type: 'LEAVE_ROOM',\n    payload: {\n      roomId\n    }\n  }),\n  sendRoomMessage: (roomId, content, senderName) => ({\n    type: 'SEND_ROOM_MESSAGE',\n    payload: {\n      roomId,\n      content,\n      senderName\n    }\n  })\n}); // === HOOKS PARA USAR NOS COMPONENTES ===\n\nexport const useCommunication = () => {\n  const actions = createCommunicationActions();\n  return { ...actions,\n    // Função para enviar mensagem com validação\n    sendMessage: (content, type = 'public', options = {}) => {\n      if (!content || content.trim() === '') {\n        throw new Error('Conteúdo da mensagem não pode estar vazio');\n      }\n\n      if (content.length > 1000) {\n        throw new Error('Mensagem muito longa (máximo 1000 caracteres)');\n      }\n\n      const trimmedContent = content.trim();\n\n      if (type === 'private') {\n        if (!options.recipientId) {\n          throw new Error('ID do destinatário é obrigatório para mensagens privadas');\n        }\n\n        return actions.sendPrivateMessage(trimmedContent, options.recipientId, options.senderName);\n      } else if (type === 'room') {\n        if (!options.roomId) {\n          throw new Error('ID da sala é obrigatório para mensagens de sala');\n        }\n\n        return actions.sendRoomMessage(options.roomId, trimmedContent, options.senderName);\n      } else {\n        return actions.sendPublicMessage(trimmedContent, options.senderName);\n      }\n    }\n  };\n};","map":{"version":3,"sources":["E:/000gitRepositorios/WorkCodeForge/client/src/middleware/socketRTK.js"],"names":["wsEndpoint","io","createPeer","addPeer","SET_VIDEO_PARTICIPANTS","SET_SOCKETID","USER_DISCONNECT","SET_ONLINE_USERS","ADD_ONLINE_USER","REMOVE_ONLINE_USER","RECEIVE_MESSAGE","RECEIVE_PRIVATE_MESSAGE","UPDATE_USER_STATUS","RECEIVE_TYPING_STATUS","RECEIVE_USER_JOINED","RECEIVE_USER_LEFT","socketRTK","storeAPI","socket","transports","peers","on","dispatch","id","emit","status","userId","timestamp","Date","now","users","Array","isArray","userToSignal","callerID","signal","peer","getState","video","localStream","type","payload","user","message","name","lastSeen","messageData","senderId","senderName","content","recipientId","userName","isTyping","socketId","destroy","arg","action","JSON","parse","err","console","error","log","next","result","state","socketArr","forEach","volatile","stringify","players","outgoingGif","profile","blockedUserId","unblockedUserId","reporterId","reportedUserId","reason","roomId","createCommunicationActions","sendPublicMessage","sendPrivateMessage","setTypingStatus","updateUserProfile","requestUserInfo","blockUser","unblockUser","reportUser","joinRoom","leaveRoom","sendRoomMessage","useCommunication","actions","sendMessage","options","trim","Error","length","trimmedContent"],"mappings":"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","sourcesContent":["// src/middleware/socketRTK.js\r\nimport { wsEndpoint } from '../utils/constants';\r\nimport { io } from 'socket.io-client';\r\nimport { createPeer, addPeer } from '../utils/peerManager';\r\nimport {\r\n  SET_VIDEO_PARTICIPANTS,\r\n  SET_SOCKETID,\r\n  USER_DISCONNECT,\r\n} from '../reducers/mapReducer';\r\n\r\n// Definir as novas ações aqui até serem adicionadas ao mapReducer\r\nconst SET_ONLINE_USERS = 'SET_ONLINE_USERS';\r\nconst ADD_ONLINE_USER = 'ADD_ONLINE_USER';\r\nconst REMOVE_ONLINE_USER = 'REMOVE_ONLINE_USER';\r\nconst RECEIVE_MESSAGE = 'RECEIVE_MESSAGE';\r\nconst RECEIVE_PRIVATE_MESSAGE = 'RECEIVE_PRIVATE_MESSAGE';\r\nconst UPDATE_USER_STATUS = 'UPDATE_USER_STATUS';\r\nconst RECEIVE_TYPING_STATUS = 'RECEIVE_TYPING_STATUS';\r\nconst RECEIVE_USER_JOINED = 'RECEIVE_USER_JOINED';\r\nconst RECEIVE_USER_LEFT = 'RECEIVE_USER_LEFT';\r\n\r\nexport const socketRTK = () => {\r\n  return (storeAPI) => {\r\n    const socket = io(wsEndpoint, { transports: ['websocket'] });\r\n    const peers = {}; // socketId => Peer instance\r\n    \r\n    // Armazena o socket ID no Redux\r\n    socket.on('connect', () => {\r\n      storeAPI.dispatch(SET_SOCKETID({ id: socket.id }));\r\n      \r\n      // Indica ao servidor que deseja participar da sala de vídeo\r\n      socket.emit('joinVideo');\r\n      \r\n      // Solicita lista de usuários online\r\n      socket.emit('requestOnlineUsers');\r\n      \r\n      // Emite status de usuário conectado\r\n      socket.emit('userStatus', { \r\n        status: 'online', \r\n        userId: socket.id,\r\n        timestamp: Date.now()\r\n      });\r\n    });\r\n\r\n    // === EVENTOS DE VÍDEO ===\r\n    // Recebe lista de participantes de vídeo\r\n    socket.on('userList', (users) => {\r\n      if (Array.isArray(users)) {\r\n        storeAPI.dispatch(SET_VIDEO_PARTICIPANTS(users));\r\n      }\r\n    });\r\n\r\n    // Quando um novo usuário inicia um peer com você\r\n    socket.on('sending-signal', ({ userToSignal, callerID, signal }) => {\r\n      const peer = addPeer({ signal, callerID }, storeAPI.getState().video.localStream, socket);\r\n      peers[callerID] = peer;\r\n    });\r\n\r\n    // Quando um usuário retorna sinal\r\n    socket.on('returning-signal', ({ callerID, signal }) => {\r\n      const peer = peers[callerID];\r\n      if (peer) peer.signal(signal);\r\n    });\r\n\r\n    // === EVENTOS DE USUÁRIOS ONLINE ===\r\n    // Lista completa de usuários online\r\n    socket.on('onlineUsers', (users) => {\r\n      storeAPI.dispatch({ type: SET_ONLINE_USERS, payload: users });\r\n    });\r\n\r\n    // Novo usuário entrou online\r\n    socket.on('userJoined', (user) => {\r\n      storeAPI.dispatch({ type: ADD_ONLINE_USER, payload: user });\r\n      storeAPI.dispatch({ \r\n        type: RECEIVE_USER_JOINED, \r\n        payload: {\r\n          message: `${user.name || user.id} entrou na plataforma`,\r\n          userId: user.id,\r\n          timestamp: Date.now()\r\n        }\r\n      });\r\n    });\r\n\r\n    // Usuário saiu\r\n    socket.on('userLeft', (user) => {\r\n      storeAPI.dispatch({ type: REMOVE_ONLINE_USER, payload: user.id });\r\n      storeAPI.dispatch({ \r\n        type: RECEIVE_USER_LEFT, \r\n        payload: {\r\n          message: `${user.name || user.id} saiu da plataforma`,\r\n          userId: user.id,\r\n          timestamp: Date.now()\r\n        }\r\n      });\r\n    });\r\n\r\n    // Status de usuário atualizado\r\n    socket.on('userStatusUpdate', ({ userId, status, lastSeen }) => {\r\n      storeAPI.dispatch({ \r\n        type: UPDATE_USER_STATUS, \r\n        payload: { userId, status, lastSeen }\r\n      });\r\n    });\r\n\r\n    // === EVENTOS DE MENSAGENS ===\r\n    // Mensagem pública no chat geral\r\n    socket.on('publicMessage', (messageData) => {\r\n      storeAPI.dispatch({ \r\n        type: RECEIVE_MESSAGE, \r\n        payload: {\r\n          id: messageData.id || Date.now(),\r\n          senderId: messageData.senderId,\r\n          senderName: messageData.senderName,\r\n          content: messageData.content,\r\n          timestamp: messageData.timestamp,\r\n          type: 'public'\r\n        }\r\n      });\r\n    });\r\n\r\n    // Mensagem privada\r\n    socket.on('privateMessage', (messageData) => {\r\n      storeAPI.dispatch({ \r\n        type: RECEIVE_PRIVATE_MESSAGE, \r\n        payload: {\r\n          id: messageData.id || Date.now(),\r\n          senderId: messageData.senderId,\r\n          senderName: messageData.senderName,\r\n          recipientId: messageData.recipientId,\r\n          content: messageData.content,\r\n          timestamp: messageData.timestamp,\r\n          type: 'private'\r\n        }\r\n      });\r\n    });\r\n\r\n    // Status de digitação\r\n    socket.on('userTyping', ({ userId, userName, isTyping }) => {\r\n      storeAPI.dispatch({ \r\n        type: RECEIVE_TYPING_STATUS, \r\n        payload: {\r\n          userId,\r\n          userName,\r\n          isTyping,\r\n          timestamp: Date.now()\r\n        }\r\n      });\r\n    });\r\n\r\n    // === EVENTOS DE DESCONEXÃO ===\r\n    socket.on('userDisconnect', (socketId) => {\r\n      storeAPI.dispatch({ type: USER_DISCONNECT, payload: socketId });\r\n      storeAPI.dispatch({ type: REMOVE_ONLINE_USER, payload: socketId });\r\n      \r\n      if (peers[socketId]) {\r\n        peers[socketId].destroy();\r\n        delete peers[socketId];\r\n      }\r\n    });\r\n\r\n    // === EVENTOS EXISTENTES ===\r\n    socket.on('movementMessage', (arg) => {\r\n      try {\r\n        const action = JSON.parse(arg);\r\n        storeAPI.dispatch(action);\r\n      } catch (err) {\r\n        console.error('Erro movementMessage:', err);\r\n      }\r\n    });\r\n\r\n    socket.on('receivedAnnouncement', (arg) => {\r\n      try {\r\n        const action = JSON.parse(arg);\r\n        storeAPI.dispatch(action);\r\n      } catch (err) {\r\n        console.error('Erro announcement:', err);\r\n      }\r\n    });\r\n\r\n    socket.on('receiveDirect', (arg) => {\r\n      if (arg?.type && arg?.payload) {\r\n        storeAPI.dispatch(arg);\r\n      }\r\n    });\r\n\r\n    // === EVENTOS DE ERRO ===\r\n    socket.on('error', (error) => {\r\n      console.error('Socket error:', error);\r\n    });\r\n\r\n    socket.on('disconnect', () => {\r\n      console.log('Desconectado do servidor');\r\n    });\r\n\r\n    // === MIDDLEWARE REDUX ===\r\n    return (next) => (action) => {\r\n      const result = next(action);\r\n      const state = storeAPI.getState();\r\n\r\n      switch (action.type) {\r\n        case 'JOIN_VIDEO':\r\n          // Criar peers iniciadores para cada participante\r\n          const { video } = state;\r\n          video.socketArr.forEach((userId) => {\r\n            if (userId !== socket.id && !peers[userId]) {\r\n              const peer = createPeer(userId, socket.id, video.localStream, socket);\r\n              peers[userId] = peer;\r\n            }\r\n          });\r\n          break;\r\n\r\n        case 'WALK':\r\n          socket.volatile.emit('movementMessage', JSON.stringify({\r\n            type: 'UPDATE_OTHERS',\r\n            payload: state.players[action.payload.id],\r\n          }));\r\n          break;\r\n\r\n        case 'ANNOUNCEMENT':\r\n          socket.emit('announcement', JSON.stringify({\r\n            type: 'RECEIVED_ANNOUNCEMENT',\r\n            payload: state.outgoingGif,\r\n          }));\r\n          break;\r\n\r\n        case 'SEND_DIRECT':\r\n          socket.emit('sendDirect', {\r\n            type: 'RECEIVE_DIRECT',\r\n            payload: state.outgoingGif,\r\n          });\r\n          break;\r\n\r\n        // === NOVAS AÇÕES DE COMUNICAÇÃO ===\r\n        case 'SEND_PUBLIC_MESSAGE':\r\n          socket.emit('publicMessage', {\r\n            content: action.payload.content,\r\n            senderId: socket.id,\r\n            senderName: action.payload.senderName || 'Anônimo',\r\n            timestamp: Date.now()\r\n          });\r\n          break;\r\n\r\n        case 'SEND_PRIVATE_MESSAGE':\r\n          socket.emit('privateMessage', {\r\n            content: action.payload.content,\r\n            recipientId: action.payload.recipientId,\r\n            senderId: socket.id,\r\n            senderName: action.payload.senderName || 'Anônimo',\r\n            timestamp: Date.now()\r\n          });\r\n          break;\r\n\r\n        case 'SET_TYPING_STATUS':\r\n          socket.emit('typing', {\r\n            isTyping: action.payload.isTyping,\r\n            userId: socket.id,\r\n            userName: action.payload.userName || 'Anônimo'\r\n          });\r\n          break;\r\n\r\n        case 'UPDATE_USER_PROFILE':\r\n          socket.emit('updateProfile', {\r\n            userId: socket.id,\r\n            profile: action.payload\r\n          });\r\n          break;\r\n\r\n        case 'REQUEST_USER_INFO':\r\n          socket.emit('requestUserInfo', {\r\n            userId: action.payload.userId\r\n          });\r\n          break;\r\n\r\n        case 'BLOCK_USER':\r\n          socket.emit('blockUser', {\r\n            userId: socket.id,\r\n            blockedUserId: action.payload.userId\r\n          });\r\n          break;\r\n\r\n        case 'UNBLOCK_USER':\r\n          socket.emit('unblockUser', {\r\n            userId: socket.id,\r\n            unblockedUserId: action.payload.userId\r\n          });\r\n          break;\r\n\r\n        case 'REPORT_USER':\r\n          socket.emit('reportUser', {\r\n            reporterId: socket.id,\r\n            reportedUserId: action.payload.userId,\r\n            reason: action.payload.reason\r\n          });\r\n          break;\r\n\r\n        case 'JOIN_ROOM':\r\n          socket.emit('joinRoom', {\r\n            roomId: action.payload.roomId,\r\n            userId: socket.id\r\n          });\r\n          break;\r\n\r\n        case 'LEAVE_ROOM':\r\n          socket.emit('leaveRoom', {\r\n            roomId: action.payload.roomId,\r\n            userId: socket.id\r\n          });\r\n          break;\r\n\r\n        case 'SEND_ROOM_MESSAGE':\r\n          socket.emit('roomMessage', {\r\n            roomId: action.payload.roomId,\r\n            content: action.payload.content,\r\n            senderId: socket.id,\r\n            senderName: action.payload.senderName || 'Anônimo',\r\n            timestamp: Date.now()\r\n          });\r\n          break;\r\n\r\n        default:\r\n          break;\r\n      }\r\n\r\n      return result;\r\n    };\r\n  };\r\n};\r\n\r\n// === FUNÇÕES AUXILIARES ===\r\nexport const createCommunicationActions = () => ({\r\n  // Mensagens públicas\r\n  sendPublicMessage: (content, senderName) => ({\r\n    type: 'SEND_PUBLIC_MESSAGE',\r\n    payload: { content, senderName }\r\n  }),\r\n\r\n  // Mensagens privadas\r\n  sendPrivateMessage: (content, recipientId, senderName) => ({\r\n    type: 'SEND_PRIVATE_MESSAGE',\r\n    payload: { content, recipientId, senderName }\r\n  }),\r\n\r\n  // Status de digitação\r\n  setTypingStatus: (isTyping, userName) => ({\r\n    type: 'SET_TYPING_STATUS',\r\n    payload: { isTyping, userName }\r\n  }),\r\n\r\n  // Atualizar perfil\r\n  updateUserProfile: (profile) => ({\r\n    type: 'UPDATE_USER_PROFILE',\r\n    payload: profile\r\n  }),\r\n\r\n  // Solicitar informações do usuário\r\n  requestUserInfo: (userId) => ({\r\n    type: 'REQUEST_USER_INFO',\r\n    payload: { userId }\r\n  }),\r\n\r\n  // Bloquear usuário\r\n  blockUser: (userId) => ({\r\n    type: 'BLOCK_USER',\r\n    payload: { userId }\r\n  }),\r\n\r\n  // Desbloquear usuário\r\n  unblockUser: (userId) => ({\r\n    type: 'UNBLOCK_USER',\r\n    payload: { userId }\r\n  }),\r\n\r\n  // Reportar usuário\r\n  reportUser: (userId, reason) => ({\r\n    type: 'REPORT_USER',\r\n    payload: { userId, reason }\r\n  }),\r\n\r\n  // Gerenciar salas\r\n  joinRoom: (roomId) => ({\r\n    type: 'JOIN_ROOM',\r\n    payload: { roomId }\r\n  }),\r\n\r\n  leaveRoom: (roomId) => ({\r\n    type: 'LEAVE_ROOM',\r\n    payload: { roomId }\r\n  }),\r\n\r\n  sendRoomMessage: (roomId, content, senderName) => ({\r\n    type: 'SEND_ROOM_MESSAGE',\r\n    payload: { roomId, content, senderName }\r\n  })\r\n});\r\n\r\n// === HOOKS PARA USAR NOS COMPONENTES ===\r\nexport const useCommunication = () => {\r\n  const actions = createCommunicationActions();\r\n  \r\n  return {\r\n    ...actions,\r\n    // Função para enviar mensagem com validação\r\n    sendMessage: (content, type = 'public', options = {}) => {\r\n      if (!content || content.trim() === '') {\r\n        throw new Error('Conteúdo da mensagem não pode estar vazio');\r\n      }\r\n\r\n      if (content.length > 1000) {\r\n        throw new Error('Mensagem muito longa (máximo 1000 caracteres)');\r\n      }\r\n\r\n      const trimmedContent = content.trim();\r\n\r\n      if (type === 'private') {\r\n        if (!options.recipientId) {\r\n          throw new Error('ID do destinatário é obrigatório para mensagens privadas');\r\n        }\r\n        return actions.sendPrivateMessage(trimmedContent, options.recipientId, options.senderName);\r\n      } else if (type === 'room') {\r\n        if (!options.roomId) {\r\n          throw new Error('ID da sala é obrigatório para mensagens de sala');\r\n        }\r\n        return actions.sendRoomMessage(options.roomId, trimmedContent, options.senderName);\r\n      } else {\r\n        return actions.sendPublicMessage(trimmedContent, options.senderName);\r\n      }\r\n    }\r\n  };\r\n};"]},"metadata":{},"sourceType":"module"}